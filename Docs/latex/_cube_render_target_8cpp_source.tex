\doxysection{Cube\+Render\+Target.\+cpp}
\label{_cube_render_target_8cpp_source}\index{Week13/DynamicCube/CubeRenderTarget.cpp@{Week13/DynamicCube/CubeRenderTarget.cpp}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001 \textcolor{comment}{//***************************************************************************************}}
\DoxyCodeLine{00002 \textcolor{comment}{// CubeRenderTarget.cpp }}
\DoxyCodeLine{00003 \textcolor{comment}{//Step2: To help render to a cube map dynamically, we create the following CubeRenderTarget class, }}
\DoxyCodeLine{00004 \textcolor{comment}{//which encapsulates the actual ID3D12Resource object of the cube map, the various descriptors to the resource, }}
\DoxyCodeLine{00005 \textcolor{comment}{//and other useful data for rendering to the cube map}}
\DoxyCodeLine{00006 \textcolor{comment}{//***************************************************************************************}}
\DoxyCodeLine{00007 }
\DoxyCodeLine{00008 \textcolor{preprocessor}{\#include "{}CubeRenderTarget.h"{}}}
\DoxyCodeLine{00009  }
\DoxyCodeLine{00010 CubeRenderTarget::CubeRenderTarget(ID3D12Device* device, }
\DoxyCodeLine{00011                            UINT width, UINT height,}
\DoxyCodeLine{00012                            DXGI\_FORMAT format)}
\DoxyCodeLine{00013 \{}
\DoxyCodeLine{00014     md3dDevice = device;}
\DoxyCodeLine{00015 }
\DoxyCodeLine{00016     mWidth = width;}
\DoxyCodeLine{00017     mHeight = height;}
\DoxyCodeLine{00018     mFormat = format;}
\DoxyCodeLine{00019 }
\DoxyCodeLine{00020     \textcolor{comment}{//step8: Because the cube map faces will have a different resolution than the main back buffer, we need to define a new viewport and scissor rectangle that covers a cube map face:}}
\DoxyCodeLine{00021     mViewport = \{ 0.0f, 0.0f, (float)width, (\textcolor{keywordtype}{float})height, 0.0f, 1.0f \};}
\DoxyCodeLine{00022     mScissorRect = \{ 0, 0, (int)width, (\textcolor{keywordtype}{int})height \};}
\DoxyCodeLine{00023 }
\DoxyCodeLine{00024     BuildResource();}
\DoxyCodeLine{00025 \}}
\DoxyCodeLine{00026 }
\DoxyCodeLine{00027 ID3D12Resource*  CubeRenderTarget::Resource()}
\DoxyCodeLine{00028 \{}
\DoxyCodeLine{00029     \textcolor{keywordflow}{return} mCubeMap.Get();}
\DoxyCodeLine{00030 \}}
\DoxyCodeLine{00031 }
\DoxyCodeLine{00032 CD3DX12\_GPU\_DESCRIPTOR\_HANDLE CubeRenderTarget::Srv()}
\DoxyCodeLine{00033 \{}
\DoxyCodeLine{00034     \textcolor{keywordflow}{return} mhGpuSrv;}
\DoxyCodeLine{00035 \}}
\DoxyCodeLine{00036 }
\DoxyCodeLine{00037 CD3DX12\_CPU\_DESCRIPTOR\_HANDLE CubeRenderTarget::Rtv(\textcolor{keywordtype}{int} faceIndex)}
\DoxyCodeLine{00038 \{}
\DoxyCodeLine{00039     \textcolor{keywordflow}{return} mhCpuRtv[faceIndex];}
\DoxyCodeLine{00040 \}}
\DoxyCodeLine{00041 }
\DoxyCodeLine{00042 D3D12\_VIEWPORT CubeRenderTarget::Viewport()\textcolor{keyword}{const}}
\DoxyCodeLine{00043 \textcolor{keyword}{}\{}
\DoxyCodeLine{00044     \textcolor{keywordflow}{return} mViewport;}
\DoxyCodeLine{00045 \}}
\DoxyCodeLine{00046 }
\DoxyCodeLine{00047 D3D12\_RECT CubeRenderTarget::ScissorRect()\textcolor{keyword}{const}}
\DoxyCodeLine{00048 \textcolor{keyword}{}\{}
\DoxyCodeLine{00049     \textcolor{keywordflow}{return} mScissorRect;}
\DoxyCodeLine{00050 \}}
\DoxyCodeLine{00051 }
\DoxyCodeLine{00052 \textcolor{keywordtype}{void} CubeRenderTarget::BuildDescriptors(CD3DX12\_CPU\_DESCRIPTOR\_HANDLE hCpuSrv,}
\DoxyCodeLine{00053                                     CD3DX12\_GPU\_DESCRIPTOR\_HANDLE hGpuSrv,}
\DoxyCodeLine{00054                                     CD3DX12\_CPU\_DESCRIPTOR\_HANDLE hCpuRtv[6])}
\DoxyCodeLine{00055 \{}
\DoxyCodeLine{00056     \textcolor{comment}{// Save references to the descriptors. }}
\DoxyCodeLine{00057     mhCpuSrv = hCpuSrv;}
\DoxyCodeLine{00058     mhGpuSrv = hGpuSrv;}
\DoxyCodeLine{00059 }
\DoxyCodeLine{00060     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 6; ++i)}
\DoxyCodeLine{00061         mhCpuRtv[i] = hCpuRtv[i];}
\DoxyCodeLine{00062 }
\DoxyCodeLine{00063     \textcolor{comment}{//  Create the descriptors}}
\DoxyCodeLine{00064     BuildDescriptors();}
\DoxyCodeLine{00065 \}}
\DoxyCodeLine{00066 }
\DoxyCodeLine{00067 \textcolor{keywordtype}{void} CubeRenderTarget::OnResize(UINT newWidth, UINT newHeight)}
\DoxyCodeLine{00068 \{}
\DoxyCodeLine{00069     \textcolor{keywordflow}{if}((mWidth != newWidth) || (mHeight != newHeight))}
\DoxyCodeLine{00070     \{}
\DoxyCodeLine{00071         mWidth = newWidth;}
\DoxyCodeLine{00072         mHeight = newHeight;}
\DoxyCodeLine{00073 }
\DoxyCodeLine{00074         BuildResource();}
\DoxyCodeLine{00075 }
\DoxyCodeLine{00076         \textcolor{comment}{// New resource, so we need new descriptors to that resource.}}
\DoxyCodeLine{00077         BuildDescriptors();}
\DoxyCodeLine{00078     \}}
\DoxyCodeLine{00079 \}}
\DoxyCodeLine{00080  }
\DoxyCodeLine{00081 \textcolor{keywordtype}{void} CubeRenderTarget::BuildDescriptors()}
\DoxyCodeLine{00082 \{}
\DoxyCodeLine{00083     \textcolor{comment}{//step5: We now need to create an SRV to the cube map resource so that we can sample it in a pixel shader after it is built}}
\DoxyCodeLine{00084     D3D12\_SHADER\_RESOURCE\_VIEW\_DESC srvDesc = \{\};}
\DoxyCodeLine{00085     srvDesc.Shader4ComponentMapping = D3D12\_DEFAULT\_SHADER\_4\_COMPONENT\_MAPPING;}
\DoxyCodeLine{00086     srvDesc.Format = mFormat;}
\DoxyCodeLine{00087     srvDesc.ViewDimension = D3D12\_SRV\_DIMENSION\_TEXTURECUBE;}
\DoxyCodeLine{00088     srvDesc.TextureCube.MostDetailedMip = 0;}
\DoxyCodeLine{00089     srvDesc.TextureCube.MipLevels = 1;}
\DoxyCodeLine{00090     srvDesc.TextureCube.ResourceMinLODClamp = 0.0f;}
\DoxyCodeLine{00091 }
\DoxyCodeLine{00092     \textcolor{comment}{// Create SRV to the entire cubemap resource.}}
\DoxyCodeLine{00093     md3dDevice-\/>CreateShaderResourceView(mCubeMap.Get(), \&srvDesc, mhCpuSrv);}
\DoxyCodeLine{00094 }
\DoxyCodeLine{00095     \textcolor{comment}{// step 6: We also need to create a render target view to each element in the cube map texture array, so that we can render onto each cube map face one by one. }}
\DoxyCodeLine{00096     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 6; ++i)}
\DoxyCodeLine{00097     \{}
\DoxyCodeLine{00098         D3D12\_RENDER\_TARGET\_VIEW\_DESC rtvDesc; }
\DoxyCodeLine{00099         rtvDesc.ViewDimension = D3D12\_RTV\_DIMENSION\_TEXTURE2DARRAY;}
\DoxyCodeLine{00100         rtvDesc.Format = mFormat;}
\DoxyCodeLine{00101         rtvDesc.Texture2DArray.MipSlice = 0;}
\DoxyCodeLine{00102         rtvDesc.Texture2DArray.PlaneSlice = 0;}
\DoxyCodeLine{00103 }
\DoxyCodeLine{00104         \textcolor{comment}{// Render target to ith element.}}
\DoxyCodeLine{00105         rtvDesc.Texture2DArray.FirstArraySlice = i;}
\DoxyCodeLine{00106 }
\DoxyCodeLine{00107         \textcolor{comment}{// Only view one element of the array.}}
\DoxyCodeLine{00108         rtvDesc.Texture2DArray.ArraySize = 1;}
\DoxyCodeLine{00109 }
\DoxyCodeLine{00110         \textcolor{comment}{// Create RTV to ith cubemap face.}}
\DoxyCodeLine{00111         md3dDevice-\/>CreateRenderTargetView(mCubeMap.Get(), \&rtvDesc, mhCpuRtv[i]);}
\DoxyCodeLine{00112     \}}
\DoxyCodeLine{00113 \}}
\DoxyCodeLine{00114 }
\DoxyCodeLine{00115 }
\DoxyCodeLine{00116 \textcolor{keywordtype}{void} CubeRenderTarget::BuildResource()}
\DoxyCodeLine{00117 \{}
\DoxyCodeLine{00118     \textcolor{comment}{// Note, compressed formats cannot be used for UAV.  We get error like:}}
\DoxyCodeLine{00119     \textcolor{comment}{// ERROR: ID3D11Device::CreateTexture2D: The format (0x4d, BC3\_UNORM) }}
\DoxyCodeLine{00120     \textcolor{comment}{// cannot be bound as an UnorderedAccessView, or cast to a format that}}
\DoxyCodeLine{00121     \textcolor{comment}{// could be bound as an UnorderedAccessView.  Therefore this format }}
\DoxyCodeLine{00122     \textcolor{comment}{// does not support D3D11\_BIND\_UNORDERED\_ACCESS.}}
\DoxyCodeLine{00123 }
\DoxyCodeLine{00124     D3D12\_RESOURCE\_DESC texDesc;}
\DoxyCodeLine{00125     ZeroMemory(\&texDesc, \textcolor{keyword}{sizeof}(D3D12\_RESOURCE\_DESC));}
\DoxyCodeLine{00126     texDesc.Dimension = D3D12\_RESOURCE\_DIMENSION\_TEXTURE2D;}
\DoxyCodeLine{00127     texDesc.Alignment = 0;}
\DoxyCodeLine{00128     texDesc.Width = mWidth;}
\DoxyCodeLine{00129     texDesc.Height = mHeight;}
\DoxyCodeLine{00130     \textcolor{comment}{//step2: Creating a cube map texture is done by creating a texture array with six elements (one for each face). }}
\DoxyCodeLine{00131     texDesc.DepthOrArraySize = 6;}
\DoxyCodeLine{00132     texDesc.MipLevels = 1;}
\DoxyCodeLine{00133     texDesc.Format = mFormat;}
\DoxyCodeLine{00134     texDesc.SampleDesc.Count = 1;}
\DoxyCodeLine{00135     texDesc.SampleDesc.Quality = 0;}
\DoxyCodeLine{00136     texDesc.Layout = D3D12\_TEXTURE\_LAYOUT\_UNKNOWN;}
\DoxyCodeLine{00137     \textcolor{comment}{//step3: Because we are going to render to the cube map, we must set the D3D12\_RESOURCE\_FLAG\_ALLOW\_RENDER\_TARGET flag. }}
\DoxyCodeLine{00138     texDesc.Flags = D3D12\_RESOURCE\_FLAG\_ALLOW\_RENDER\_TARGET;}
\DoxyCodeLine{00139 }
\DoxyCodeLine{00140     ThrowIfFailed(md3dDevice-\/>CreateCommittedResource(}
\DoxyCodeLine{00141         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_DEFAULT),}
\DoxyCodeLine{00142         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00143         \&texDesc,}
\DoxyCodeLine{00144         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00145         \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00146         IID\_PPV\_ARGS(\&mCubeMap)));}
\DoxyCodeLine{00147 \}}

\end{DoxyCode}
