\doxysection{Ssao.\+cpp}
\label{_week15_2_skinned_mesh_2_ssao_8cpp_source}\index{Week15/SkinnedMesh/Ssao.cpp@{Week15/SkinnedMesh/Ssao.cpp}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001 \textcolor{comment}{//***************************************************************************************}}
\DoxyCodeLine{00002 \textcolor{comment}{// Ssao.cpp by Frank Luna (C) 2011 All Rights Reserved.}}
\DoxyCodeLine{00003 \textcolor{comment}{//***************************************************************************************}}
\DoxyCodeLine{00004 }
\DoxyCodeLine{00005 \textcolor{preprocessor}{\#include "{}Ssao.h"{}}}
\DoxyCodeLine{00006 \textcolor{preprocessor}{\#include <DirectXPackedVector.h>}}
\DoxyCodeLine{00007 }
\DoxyCodeLine{00008 \textcolor{keyword}{using namespace }DirectX;}
\DoxyCodeLine{00009 \textcolor{keyword}{using namespace }DirectX::PackedVector;}
\DoxyCodeLine{00010 \textcolor{keyword}{using namespace }Microsoft::WRL;}
\DoxyCodeLine{00011 }
\DoxyCodeLine{00012 Ssao::Ssao(}
\DoxyCodeLine{00013     ID3D12Device* device,}
\DoxyCodeLine{00014     ID3D12GraphicsCommandList* cmdList, }
\DoxyCodeLine{00015     UINT width, UINT height)}
\DoxyCodeLine{00016 }
\DoxyCodeLine{00017 \{}
\DoxyCodeLine{00018     md3dDevice = device;}
\DoxyCodeLine{00019 }
\DoxyCodeLine{00020     OnResize(width, height);}
\DoxyCodeLine{00021 }
\DoxyCodeLine{00022     BuildOffsetVectors();}
\DoxyCodeLine{00023     BuildRandomVectorTexture(cmdList);}
\DoxyCodeLine{00024 \}}
\DoxyCodeLine{00025 }
\DoxyCodeLine{00026 UINT Ssao::SsaoMapWidth()\textcolor{keyword}{const}}
\DoxyCodeLine{00027 \textcolor{keyword}{}\{}
\DoxyCodeLine{00028     \textcolor{keywordflow}{return} mRenderTargetWidth / 2;}
\DoxyCodeLine{00029 \}}
\DoxyCodeLine{00030 }
\DoxyCodeLine{00031 UINT Ssao::SsaoMapHeight()\textcolor{keyword}{const}}
\DoxyCodeLine{00032 \textcolor{keyword}{}\{}
\DoxyCodeLine{00033     \textcolor{keywordflow}{return} mRenderTargetHeight / 2;}
\DoxyCodeLine{00034 \}}
\DoxyCodeLine{00035 }
\DoxyCodeLine{00036 \textcolor{keywordtype}{void} Ssao::GetOffsetVectors(DirectX::XMFLOAT4 offsets[14])}
\DoxyCodeLine{00037 \{}
\DoxyCodeLine{00038     std::copy(\&mOffsets[0], \&mOffsets[14], \&offsets[0]);}
\DoxyCodeLine{00039 \}}
\DoxyCodeLine{00040 }
\DoxyCodeLine{00041 std::vector<float> Ssao::CalcGaussWeights(\textcolor{keywordtype}{float} sigma)}
\DoxyCodeLine{00042 \{}
\DoxyCodeLine{00043     \textcolor{keywordtype}{float} twoSigma2 = 2.0f*sigma*sigma;}
\DoxyCodeLine{00044 }
\DoxyCodeLine{00045     \textcolor{comment}{// Estimate the blur radius based on sigma since sigma controls the "{}width"{} of the bell curve.}}
\DoxyCodeLine{00046     \textcolor{comment}{// For example, for sigma = 3, the width of the bell curve is }}
\DoxyCodeLine{00047     \textcolor{keywordtype}{int} blurRadius = (int)ceil(2.0f * sigma);}
\DoxyCodeLine{00048 }
\DoxyCodeLine{00049     assert(blurRadius <= MaxBlurRadius);}
\DoxyCodeLine{00050 }
\DoxyCodeLine{00051     std::vector<float> weights;}
\DoxyCodeLine{00052     weights.resize(2 * blurRadius + 1);}
\DoxyCodeLine{00053 }
\DoxyCodeLine{00054     \textcolor{keywordtype}{float} weightSum = 0.0f;}
\DoxyCodeLine{00055 }
\DoxyCodeLine{00056     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = -\/blurRadius; i <= blurRadius; ++i)}
\DoxyCodeLine{00057     \{}
\DoxyCodeLine{00058         \textcolor{keywordtype}{float} x = (float)i;}
\DoxyCodeLine{00059 }
\DoxyCodeLine{00060         weights[i + blurRadius] = expf(-\/x*x / twoSigma2);}
\DoxyCodeLine{00061 }
\DoxyCodeLine{00062         weightSum += weights[i + blurRadius];}
\DoxyCodeLine{00063     \}}
\DoxyCodeLine{00064 }
\DoxyCodeLine{00065     \textcolor{comment}{// Divide by the sum so all the weights add up to 1.0.}}
\DoxyCodeLine{00066     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < weights.size(); ++i)}
\DoxyCodeLine{00067     \{}
\DoxyCodeLine{00068         weights[i] /= weightSum;}
\DoxyCodeLine{00069     \}}
\DoxyCodeLine{00070 }
\DoxyCodeLine{00071     \textcolor{keywordflow}{return} weights;}
\DoxyCodeLine{00072 \}}
\DoxyCodeLine{00073 }
\DoxyCodeLine{00074 ID3D12Resource* Ssao::NormalMap()}
\DoxyCodeLine{00075 \{}
\DoxyCodeLine{00076     \textcolor{keywordflow}{return} mNormalMap.Get();}
\DoxyCodeLine{00077 \}}
\DoxyCodeLine{00078 }
\DoxyCodeLine{00079 ID3D12Resource* Ssao::AmbientMap()}
\DoxyCodeLine{00080 \{}
\DoxyCodeLine{00081     \textcolor{keywordflow}{return} mAmbientMap0.Get();}
\DoxyCodeLine{00082 \}}
\DoxyCodeLine{00083 }
\DoxyCodeLine{00084 CD3DX12\_CPU\_DESCRIPTOR\_HANDLE Ssao::NormalMapRtv()\textcolor{keyword}{const}}
\DoxyCodeLine{00085 \textcolor{keyword}{}\{}
\DoxyCodeLine{00086     \textcolor{keywordflow}{return} mhNormalMapCpuRtv;}
\DoxyCodeLine{00087 \}}
\DoxyCodeLine{00088 }
\DoxyCodeLine{00089 CD3DX12\_GPU\_DESCRIPTOR\_HANDLE Ssao::NormalMapSrv()\textcolor{keyword}{const}}
\DoxyCodeLine{00090 \textcolor{keyword}{}\{}
\DoxyCodeLine{00091     \textcolor{keywordflow}{return} mhNormalMapGpuSrv;}
\DoxyCodeLine{00092 \}}
\DoxyCodeLine{00093 }
\DoxyCodeLine{00094 CD3DX12\_GPU\_DESCRIPTOR\_HANDLE Ssao::AmbientMapSrv()\textcolor{keyword}{const}}
\DoxyCodeLine{00095 \textcolor{keyword}{}\{}
\DoxyCodeLine{00096     \textcolor{keywordflow}{return} mhAmbientMap0GpuSrv;}
\DoxyCodeLine{00097 \}}
\DoxyCodeLine{00098 }
\DoxyCodeLine{00099 \textcolor{keywordtype}{void} Ssao::BuildDescriptors(}
\DoxyCodeLine{00100     ID3D12Resource* depthStencilBuffer,}
\DoxyCodeLine{00101     CD3DX12\_CPU\_DESCRIPTOR\_HANDLE hCpuSrv,}
\DoxyCodeLine{00102     CD3DX12\_GPU\_DESCRIPTOR\_HANDLE hGpuSrv,}
\DoxyCodeLine{00103     CD3DX12\_CPU\_DESCRIPTOR\_HANDLE hCpuRtv,}
\DoxyCodeLine{00104     UINT cbvSrvUavDescriptorSize,}
\DoxyCodeLine{00105     UINT rtvDescriptorSize)}
\DoxyCodeLine{00106 \{}
\DoxyCodeLine{00107     \textcolor{comment}{// Save references to the descriptors.  The Ssao reserves heap space}}
\DoxyCodeLine{00108     \textcolor{comment}{// for 5 contiguous Srvs.}}
\DoxyCodeLine{00109 }
\DoxyCodeLine{00110     mhAmbientMap0CpuSrv = hCpuSrv;}
\DoxyCodeLine{00111     mhAmbientMap1CpuSrv = hCpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00112     mhNormalMapCpuSrv = hCpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00113     mhDepthMapCpuSrv = hCpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00114     mhRandomVectorMapCpuSrv = hCpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00115 }
\DoxyCodeLine{00116     mhAmbientMap0GpuSrv = hGpuSrv;}
\DoxyCodeLine{00117     mhAmbientMap1GpuSrv = hGpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00118     mhNormalMapGpuSrv = hGpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00119     mhDepthMapGpuSrv = hGpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00120     mhRandomVectorMapGpuSrv = hGpuSrv.Offset(1, cbvSrvUavDescriptorSize);}
\DoxyCodeLine{00121 }
\DoxyCodeLine{00122     mhNormalMapCpuRtv = hCpuRtv;}
\DoxyCodeLine{00123     mhAmbientMap0CpuRtv = hCpuRtv.Offset(1, rtvDescriptorSize);}
\DoxyCodeLine{00124     mhAmbientMap1CpuRtv = hCpuRtv.Offset(1, rtvDescriptorSize);}
\DoxyCodeLine{00125 }
\DoxyCodeLine{00126     \textcolor{comment}{//  Create the descriptors}}
\DoxyCodeLine{00127     RebuildDescriptors(depthStencilBuffer);}
\DoxyCodeLine{00128 \}}
\DoxyCodeLine{00129 }
\DoxyCodeLine{00130 \textcolor{keywordtype}{void} Ssao::RebuildDescriptors(ID3D12Resource* depthStencilBuffer)}
\DoxyCodeLine{00131 \{}
\DoxyCodeLine{00132     D3D12\_SHADER\_RESOURCE\_VIEW\_DESC srvDesc = \{\};}
\DoxyCodeLine{00133     srvDesc.Shader4ComponentMapping = D3D12\_DEFAULT\_SHADER\_4\_COMPONENT\_MAPPING;}
\DoxyCodeLine{00134     srvDesc.ViewDimension = D3D12\_SRV\_DIMENSION\_TEXTURE2D;}
\DoxyCodeLine{00135     srvDesc.Format = NormalMapFormat;}
\DoxyCodeLine{00136     srvDesc.Texture2D.MostDetailedMip = 0;}
\DoxyCodeLine{00137     srvDesc.Texture2D.MipLevels = 1;}
\DoxyCodeLine{00138     md3dDevice-\/>CreateShaderResourceView(mNormalMap.Get(), \&srvDesc, mhNormalMapCpuSrv);}
\DoxyCodeLine{00139 }
\DoxyCodeLine{00140     srvDesc.Format = DXGI\_FORMAT\_R24\_UNORM\_X8\_TYPELESS;}
\DoxyCodeLine{00141     md3dDevice-\/>CreateShaderResourceView(depthStencilBuffer, \&srvDesc, mhDepthMapCpuSrv);}
\DoxyCodeLine{00142 }
\DoxyCodeLine{00143     srvDesc.Format = DXGI\_FORMAT\_R8G8B8A8\_UNORM;}
\DoxyCodeLine{00144     md3dDevice-\/>CreateShaderResourceView(mRandomVectorMap.Get(), \&srvDesc, mhRandomVectorMapCpuSrv);}
\DoxyCodeLine{00145 }
\DoxyCodeLine{00146     srvDesc.Format = AmbientMapFormat;}
\DoxyCodeLine{00147     md3dDevice-\/>CreateShaderResourceView(mAmbientMap0.Get(), \&srvDesc, mhAmbientMap0CpuSrv);}
\DoxyCodeLine{00148     md3dDevice-\/>CreateShaderResourceView(mAmbientMap1.Get(), \&srvDesc, mhAmbientMap1CpuSrv);}
\DoxyCodeLine{00149 }
\DoxyCodeLine{00150     D3D12\_RENDER\_TARGET\_VIEW\_DESC rtvDesc = \{\};}
\DoxyCodeLine{00151     rtvDesc.ViewDimension = D3D12\_RTV\_DIMENSION\_TEXTURE2D;}
\DoxyCodeLine{00152     rtvDesc.Format = NormalMapFormat;}
\DoxyCodeLine{00153     rtvDesc.Texture2D.MipSlice = 0;}
\DoxyCodeLine{00154     rtvDesc.Texture2D.PlaneSlice = 0;}
\DoxyCodeLine{00155     md3dDevice-\/>CreateRenderTargetView(mNormalMap.Get(), \&rtvDesc, mhNormalMapCpuRtv);}
\DoxyCodeLine{00156 }
\DoxyCodeLine{00157     rtvDesc.Format = AmbientMapFormat;}
\DoxyCodeLine{00158     md3dDevice-\/>CreateRenderTargetView(mAmbientMap0.Get(), \&rtvDesc, mhAmbientMap0CpuRtv);}
\DoxyCodeLine{00159     md3dDevice-\/>CreateRenderTargetView(mAmbientMap1.Get(), \&rtvDesc, mhAmbientMap1CpuRtv);}
\DoxyCodeLine{00160 \}}
\DoxyCodeLine{00161 }
\DoxyCodeLine{00162 \textcolor{keywordtype}{void} Ssao::SetPSOs(ID3D12PipelineState* ssaoPso, ID3D12PipelineState* ssaoBlurPso)}
\DoxyCodeLine{00163 \{}
\DoxyCodeLine{00164     mSsaoPso = ssaoPso;}
\DoxyCodeLine{00165     mBlurPso = ssaoBlurPso;}
\DoxyCodeLine{00166 \}}
\DoxyCodeLine{00167 }
\DoxyCodeLine{00168 \textcolor{keywordtype}{void} Ssao::OnResize(UINT newWidth, UINT newHeight)}
\DoxyCodeLine{00169 \{}
\DoxyCodeLine{00170     \textcolor{keywordflow}{if}(mRenderTargetWidth != newWidth || mRenderTargetHeight != newHeight)}
\DoxyCodeLine{00171     \{}
\DoxyCodeLine{00172         mRenderTargetWidth = newWidth;}
\DoxyCodeLine{00173         mRenderTargetHeight = newHeight;}
\DoxyCodeLine{00174 }
\DoxyCodeLine{00175         \textcolor{comment}{// We render to ambient map at half the resolution.}}
\DoxyCodeLine{00176         mViewport.TopLeftX = 0.0f;}
\DoxyCodeLine{00177         mViewport.TopLeftY = 0.0f;}
\DoxyCodeLine{00178         mViewport.Width = mRenderTargetWidth / 2.0f;}
\DoxyCodeLine{00179         mViewport.Height = mRenderTargetHeight / 2.0f;}
\DoxyCodeLine{00180         mViewport.MinDepth = 0.0f;}
\DoxyCodeLine{00181         mViewport.MaxDepth = 1.0f;}
\DoxyCodeLine{00182 }
\DoxyCodeLine{00183         mScissorRect = \{ 0, 0, (int)mRenderTargetWidth / 2, (\textcolor{keywordtype}{int})mRenderTargetHeight / 2 \};}
\DoxyCodeLine{00184 }
\DoxyCodeLine{00185         BuildResources();}
\DoxyCodeLine{00186     \}}
\DoxyCodeLine{00187 \}}
\DoxyCodeLine{00188 }
\DoxyCodeLine{00189 \textcolor{keywordtype}{void} Ssao::ComputeSsao(}
\DoxyCodeLine{00190     ID3D12GraphicsCommandList* cmdList,}
\DoxyCodeLine{00191     FrameResource* currFrame, }
\DoxyCodeLine{00192     \textcolor{keywordtype}{int} blurCount)}
\DoxyCodeLine{00193 \{}
\DoxyCodeLine{00194     cmdList-\/>RSSetViewports(1, \&mViewport);}
\DoxyCodeLine{00195     cmdList-\/>RSSetScissorRects(1, \&mScissorRect);}
\DoxyCodeLine{00196 }
\DoxyCodeLine{00197     \textcolor{comment}{// We compute the initial SSAO to AmbientMap0.}}
\DoxyCodeLine{00198 }
\DoxyCodeLine{00199     \textcolor{comment}{// Change to RENDER\_TARGET.}}
\DoxyCodeLine{00200     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(mAmbientMap0.Get(),}
\DoxyCodeLine{00201         D3D12\_RESOURCE\_STATE\_GENERIC\_READ, D3D12\_RESOURCE\_STATE\_RENDER\_TARGET));}
\DoxyCodeLine{00202   }
\DoxyCodeLine{00203     \textcolor{keywordtype}{float} clearValue[] = \{1.0f, 1.0f, 1.0f, 1.0f\};}
\DoxyCodeLine{00204     cmdList-\/>ClearRenderTargetView(mhAmbientMap0CpuRtv, clearValue, 0, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00205      }
\DoxyCodeLine{00206     \textcolor{comment}{// Specify the buffers we are going to render to.}}
\DoxyCodeLine{00207     cmdList-\/>OMSetRenderTargets(1, \&mhAmbientMap0CpuRtv, \textcolor{keyword}{true}, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00208 }
\DoxyCodeLine{00209     \textcolor{comment}{// Bind the constant buffer for this pass.}}
\DoxyCodeLine{00210     \textcolor{keyword}{auto} ssaoCBAddress = currFrame-\/>SsaoCB-\/>Resource()-\/>GetGPUVirtualAddress();}
\DoxyCodeLine{00211     cmdList-\/>SetGraphicsRootConstantBufferView(0, ssaoCBAddress);}
\DoxyCodeLine{00212     cmdList-\/>SetGraphicsRoot32BitConstant(1, 0, 0);}
\DoxyCodeLine{00213 }
\DoxyCodeLine{00214     \textcolor{comment}{// Bind the normal and depth maps.}}
\DoxyCodeLine{00215     cmdList-\/>SetGraphicsRootDescriptorTable(2, mhNormalMapGpuSrv);}
\DoxyCodeLine{00216 }
\DoxyCodeLine{00217     \textcolor{comment}{// Bind the random vector map.}}
\DoxyCodeLine{00218     cmdList-\/>SetGraphicsRootDescriptorTable(3, mhRandomVectorMapGpuSrv);}
\DoxyCodeLine{00219 }
\DoxyCodeLine{00220     cmdList-\/>SetPipelineState(mSsaoPso);}
\DoxyCodeLine{00221 }
\DoxyCodeLine{00222     \textcolor{comment}{// Draw fullscreen quad.}}
\DoxyCodeLine{00223     cmdList-\/>IASetVertexBuffers(0, 0, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00224     cmdList-\/>IASetIndexBuffer(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00225     cmdList-\/>IASetPrimitiveTopology(D3D\_PRIMITIVE\_TOPOLOGY\_TRIANGLELIST);}
\DoxyCodeLine{00226     cmdList-\/>DrawInstanced(6, 1, 0, 0);}
\DoxyCodeLine{00227    }
\DoxyCodeLine{00228     \textcolor{comment}{// Change back to GENERIC\_READ so we can read the texture in a shader.}}
\DoxyCodeLine{00229     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(mAmbientMap0.Get(),}
\DoxyCodeLine{00230         D3D12\_RESOURCE\_STATE\_RENDER\_TARGET, D3D12\_RESOURCE\_STATE\_GENERIC\_READ));}
\DoxyCodeLine{00231 }
\DoxyCodeLine{00232     BlurAmbientMap(cmdList, currFrame, blurCount);}
\DoxyCodeLine{00233 \}}
\DoxyCodeLine{00234  }
\DoxyCodeLine{00235 \textcolor{keywordtype}{void} Ssao::BlurAmbientMap(ID3D12GraphicsCommandList* cmdList, FrameResource* currFrame, \textcolor{keywordtype}{int} blurCount)}
\DoxyCodeLine{00236 \{}
\DoxyCodeLine{00237     cmdList-\/>SetPipelineState(mBlurPso);}
\DoxyCodeLine{00238 }
\DoxyCodeLine{00239     \textcolor{keyword}{auto} ssaoCBAddress = currFrame-\/>SsaoCB-\/>Resource()-\/>GetGPUVirtualAddress();}
\DoxyCodeLine{00240     cmdList-\/>SetGraphicsRootConstantBufferView(0, ssaoCBAddress);}
\DoxyCodeLine{00241  }
\DoxyCodeLine{00242     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < blurCount; ++i)}
\DoxyCodeLine{00243     \{}
\DoxyCodeLine{00244         BlurAmbientMap(cmdList, \textcolor{keyword}{true});}
\DoxyCodeLine{00245         BlurAmbientMap(cmdList, \textcolor{keyword}{false});}
\DoxyCodeLine{00246     \}}
\DoxyCodeLine{00247 \}}
\DoxyCodeLine{00248 }
\DoxyCodeLine{00249 \textcolor{keywordtype}{void} Ssao::BlurAmbientMap(ID3D12GraphicsCommandList* cmdList, \textcolor{keywordtype}{bool} horzBlur)}
\DoxyCodeLine{00250 \{}
\DoxyCodeLine{00251     ID3D12Resource* output = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00252     CD3DX12\_GPU\_DESCRIPTOR\_HANDLE inputSrv;}
\DoxyCodeLine{00253     CD3DX12\_CPU\_DESCRIPTOR\_HANDLE outputRtv;}
\DoxyCodeLine{00254     }
\DoxyCodeLine{00255     \textcolor{comment}{// Ping-\/pong the two ambient map textures as we apply}}
\DoxyCodeLine{00256     \textcolor{comment}{// horizontal and vertical blur passes.}}
\DoxyCodeLine{00257     \textcolor{keywordflow}{if}(horzBlur == \textcolor{keyword}{true})}
\DoxyCodeLine{00258     \{}
\DoxyCodeLine{00259         output = mAmbientMap1.Get();}
\DoxyCodeLine{00260         inputSrv = mhAmbientMap0GpuSrv;}
\DoxyCodeLine{00261         outputRtv = mhAmbientMap1CpuRtv;}
\DoxyCodeLine{00262         cmdList-\/>SetGraphicsRoot32BitConstant(1, 1, 0);}
\DoxyCodeLine{00263     \}}
\DoxyCodeLine{00264     \textcolor{keywordflow}{else}}
\DoxyCodeLine{00265     \{}
\DoxyCodeLine{00266         output = mAmbientMap0.Get();}
\DoxyCodeLine{00267         inputSrv = mhAmbientMap1GpuSrv;}
\DoxyCodeLine{00268         outputRtv = mhAmbientMap0CpuRtv;}
\DoxyCodeLine{00269         cmdList-\/>SetGraphicsRoot32BitConstant(1, 0, 0);}
\DoxyCodeLine{00270     \}}
\DoxyCodeLine{00271  }
\DoxyCodeLine{00272     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(output,}
\DoxyCodeLine{00273         D3D12\_RESOURCE\_STATE\_GENERIC\_READ, D3D12\_RESOURCE\_STATE\_RENDER\_TARGET));}
\DoxyCodeLine{00274 }
\DoxyCodeLine{00275     \textcolor{keywordtype}{float} clearValue[] = \{ 1.0f, 1.0f, 1.0f, 1.0f \};}
\DoxyCodeLine{00276     cmdList-\/>ClearRenderTargetView(outputRtv, clearValue, 0, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00277  }
\DoxyCodeLine{00278     cmdList-\/>OMSetRenderTargets(1, \&outputRtv, \textcolor{keyword}{true}, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00279     }
\DoxyCodeLine{00280     \textcolor{comment}{// Normal/depth map still bound.}}
\DoxyCodeLine{00281 }
\DoxyCodeLine{00282 }
\DoxyCodeLine{00283     \textcolor{comment}{// Bind the normal and depth maps.}}
\DoxyCodeLine{00284     cmdList-\/>SetGraphicsRootDescriptorTable(2, mhNormalMapGpuSrv);}
\DoxyCodeLine{00285 }
\DoxyCodeLine{00286     \textcolor{comment}{// Bind the input ambient map to second texture table.}}
\DoxyCodeLine{00287     cmdList-\/>SetGraphicsRootDescriptorTable(3, inputSrv);}
\DoxyCodeLine{00288     }
\DoxyCodeLine{00289     \textcolor{comment}{// Draw fullscreen quad.}}
\DoxyCodeLine{00290     cmdList-\/>IASetVertexBuffers(0, 0, \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00291     cmdList-\/>IASetIndexBuffer(\textcolor{keyword}{nullptr});}
\DoxyCodeLine{00292     cmdList-\/>IASetPrimitiveTopology(D3D\_PRIMITIVE\_TOPOLOGY\_TRIANGLELIST);}
\DoxyCodeLine{00293     cmdList-\/>DrawInstanced(6, 1, 0, 0);}
\DoxyCodeLine{00294    }
\DoxyCodeLine{00295     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(output,}
\DoxyCodeLine{00296         D3D12\_RESOURCE\_STATE\_RENDER\_TARGET, D3D12\_RESOURCE\_STATE\_GENERIC\_READ));}
\DoxyCodeLine{00297 \}}
\DoxyCodeLine{00298  }
\DoxyCodeLine{00299 \textcolor{keywordtype}{void} Ssao::BuildResources()}
\DoxyCodeLine{00300 \{}
\DoxyCodeLine{00301     \textcolor{comment}{// Free the old resources if they exist.}}
\DoxyCodeLine{00302     mNormalMap = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00303     mAmbientMap0 = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00304     mAmbientMap1 = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00305 }
\DoxyCodeLine{00306     D3D12\_RESOURCE\_DESC texDesc;}
\DoxyCodeLine{00307     ZeroMemory(\&texDesc, \textcolor{keyword}{sizeof}(D3D12\_RESOURCE\_DESC));}
\DoxyCodeLine{00308     texDesc.Dimension = D3D12\_RESOURCE\_DIMENSION\_TEXTURE2D;}
\DoxyCodeLine{00309     texDesc.Alignment = 0;}
\DoxyCodeLine{00310     texDesc.Width = mRenderTargetWidth;}
\DoxyCodeLine{00311     texDesc.Height = mRenderTargetHeight;}
\DoxyCodeLine{00312     texDesc.DepthOrArraySize = 1;}
\DoxyCodeLine{00313     texDesc.MipLevels = 1;}
\DoxyCodeLine{00314     texDesc.Format = Ssao::NormalMapFormat;}
\DoxyCodeLine{00315     texDesc.SampleDesc.Count = 1;}
\DoxyCodeLine{00316     texDesc.SampleDesc.Quality = 0;}
\DoxyCodeLine{00317     texDesc.Layout = D3D12\_TEXTURE\_LAYOUT\_UNKNOWN;}
\DoxyCodeLine{00318     texDesc.Flags = D3D12\_RESOURCE\_FLAG\_ALLOW\_RENDER\_TARGET;}
\DoxyCodeLine{00319 }
\DoxyCodeLine{00320 }
\DoxyCodeLine{00321     \textcolor{keywordtype}{float} normalClearColor[] = \{ 0.0f, 0.0f, 1.0f, 0.0f \};}
\DoxyCodeLine{00322     CD3DX12\_CLEAR\_VALUE optClear(NormalMapFormat, normalClearColor);}
\DoxyCodeLine{00323     ThrowIfFailed(md3dDevice-\/>CreateCommittedResource(}
\DoxyCodeLine{00324         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_DEFAULT),}
\DoxyCodeLine{00325         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00326         \&texDesc,}
\DoxyCodeLine{00327         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00328         \&optClear,}
\DoxyCodeLine{00329         IID\_PPV\_ARGS(\&mNormalMap)));}
\DoxyCodeLine{00330 }
\DoxyCodeLine{00331     \textcolor{comment}{// Ambient occlusion maps are at half resolution.}}
\DoxyCodeLine{00332     texDesc.Width = mRenderTargetWidth / 2;}
\DoxyCodeLine{00333     texDesc.Height = mRenderTargetHeight / 2;}
\DoxyCodeLine{00334     texDesc.Format = Ssao::AmbientMapFormat;}
\DoxyCodeLine{00335 }
\DoxyCodeLine{00336     \textcolor{keywordtype}{float} ambientClearColor[] = \{ 1.0f, 1.0f, 1.0f, 1.0f \};}
\DoxyCodeLine{00337     optClear = CD3DX12\_CLEAR\_VALUE(AmbientMapFormat, ambientClearColor);}
\DoxyCodeLine{00338 }
\DoxyCodeLine{00339     ThrowIfFailed(md3dDevice-\/>CreateCommittedResource(}
\DoxyCodeLine{00340         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_DEFAULT),}
\DoxyCodeLine{00341         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00342         \&texDesc,}
\DoxyCodeLine{00343         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00344         \&optClear,}
\DoxyCodeLine{00345         IID\_PPV\_ARGS(\&mAmbientMap0)));}
\DoxyCodeLine{00346 }
\DoxyCodeLine{00347     ThrowIfFailed(md3dDevice-\/>CreateCommittedResource(}
\DoxyCodeLine{00348         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_DEFAULT),}
\DoxyCodeLine{00349         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00350         \&texDesc,}
\DoxyCodeLine{00351         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00352         \&optClear,}
\DoxyCodeLine{00353         IID\_PPV\_ARGS(\&mAmbientMap1)));}
\DoxyCodeLine{00354 \}}
\DoxyCodeLine{00355 }
\DoxyCodeLine{00356 \textcolor{keywordtype}{void} Ssao::BuildRandomVectorTexture(ID3D12GraphicsCommandList* cmdList)}
\DoxyCodeLine{00357 \{}
\DoxyCodeLine{00358     D3D12\_RESOURCE\_DESC texDesc;}
\DoxyCodeLine{00359     ZeroMemory(\&texDesc, \textcolor{keyword}{sizeof}(D3D12\_RESOURCE\_DESC));}
\DoxyCodeLine{00360     texDesc.Dimension = D3D12\_RESOURCE\_DIMENSION\_TEXTURE2D;}
\DoxyCodeLine{00361     texDesc.Alignment = 0;}
\DoxyCodeLine{00362     texDesc.Width = 256;}
\DoxyCodeLine{00363     texDesc.Height = 256;}
\DoxyCodeLine{00364     texDesc.DepthOrArraySize = 1;}
\DoxyCodeLine{00365     texDesc.MipLevels = 1;}
\DoxyCodeLine{00366     texDesc.Format = DXGI\_FORMAT\_R8G8B8A8\_UNORM;}
\DoxyCodeLine{00367     texDesc.SampleDesc.Count = 1;}
\DoxyCodeLine{00368     texDesc.SampleDesc.Quality = 0;}
\DoxyCodeLine{00369     texDesc.Layout = D3D12\_TEXTURE\_LAYOUT\_UNKNOWN;}
\DoxyCodeLine{00370     texDesc.Flags = D3D12\_RESOURCE\_FLAG\_NONE;}
\DoxyCodeLine{00371 }
\DoxyCodeLine{00372     ThrowIfFailed(md3dDevice-\/>CreateCommittedResource(}
\DoxyCodeLine{00373         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_DEFAULT),}
\DoxyCodeLine{00374         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00375         \&texDesc,}
\DoxyCodeLine{00376         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00377         \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00378         IID\_PPV\_ARGS(\&mRandomVectorMap)));}
\DoxyCodeLine{00379 }
\DoxyCodeLine{00380     \textcolor{comment}{//}}
\DoxyCodeLine{00381     \textcolor{comment}{// In order to copy CPU memory data into our default buffer, we need to create}}
\DoxyCodeLine{00382     \textcolor{comment}{// an intermediate upload heap. }}
\DoxyCodeLine{00383     \textcolor{comment}{//}}
\DoxyCodeLine{00384 }
\DoxyCodeLine{00385     \textcolor{keyword}{const} UINT num2DSubresources = texDesc.DepthOrArraySize * texDesc.MipLevels;}
\DoxyCodeLine{00386     \textcolor{keyword}{const} UINT64 uploadBufferSize = GetRequiredIntermediateSize(mRandomVectorMap.Get(), 0, num2DSubresources);}
\DoxyCodeLine{00387 }
\DoxyCodeLine{00388     ThrowIfFailed(md3dDevice-\/>CreateCommittedResource(}
\DoxyCodeLine{00389         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_UPLOAD),}
\DoxyCodeLine{00390         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00391         \&CD3DX12\_RESOURCE\_DESC::Buffer(uploadBufferSize),}
\DoxyCodeLine{00392         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00393         \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00394         IID\_PPV\_ARGS(mRandomVectorMapUploadBuffer.GetAddressOf())));}
\DoxyCodeLine{00395 }
\DoxyCodeLine{00396     XMCOLOR initData[256 * 256];}
\DoxyCodeLine{00397     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 256; ++i)}
\DoxyCodeLine{00398     \{}
\DoxyCodeLine{00399         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} j = 0; j < 256; ++j)}
\DoxyCodeLine{00400         \{}
\DoxyCodeLine{00401             \textcolor{comment}{// Random vector in [0,1].  We will decompress in shader to [-\/1,1].}}
\DoxyCodeLine{00402             XMFLOAT3 v(MathHelper::RandF(), MathHelper::RandF(), MathHelper::RandF());}
\DoxyCodeLine{00403 }
\DoxyCodeLine{00404             initData[i * 256 + j] = XMCOLOR(v.x, v.y, v.z, 0.0f);}
\DoxyCodeLine{00405         \}}
\DoxyCodeLine{00406     \}}
\DoxyCodeLine{00407 }
\DoxyCodeLine{00408     D3D12\_SUBRESOURCE\_DATA subResourceData = \{\};}
\DoxyCodeLine{00409     subResourceData.pData = initData;}
\DoxyCodeLine{00410     subResourceData.RowPitch = 256 * \textcolor{keyword}{sizeof}(XMCOLOR);}
\DoxyCodeLine{00411     subResourceData.SlicePitch = subResourceData.RowPitch * 256;}
\DoxyCodeLine{00412 }
\DoxyCodeLine{00413     \textcolor{comment}{//}}
\DoxyCodeLine{00414     \textcolor{comment}{// Schedule to copy the data to the default resource, and change states.}}
\DoxyCodeLine{00415     \textcolor{comment}{// Note that mCurrSol is put in the GENERIC\_READ state so it can be }}
\DoxyCodeLine{00416     \textcolor{comment}{// read by a shader.}}
\DoxyCodeLine{00417     \textcolor{comment}{//}}
\DoxyCodeLine{00418 }
\DoxyCodeLine{00419     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(mRandomVectorMap.Get(),}
\DoxyCodeLine{00420         D3D12\_RESOURCE\_STATE\_GENERIC\_READ, D3D12\_RESOURCE\_STATE\_COPY\_DEST));}
\DoxyCodeLine{00421     UpdateSubresources(cmdList, mRandomVectorMap.Get(), mRandomVectorMapUploadBuffer.Get(),}
\DoxyCodeLine{00422         0, 0, num2DSubresources, \&subResourceData);}
\DoxyCodeLine{00423     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(mRandomVectorMap.Get(),}
\DoxyCodeLine{00424         D3D12\_RESOURCE\_STATE\_COPY\_DEST, D3D12\_RESOURCE\_STATE\_GENERIC\_READ));}
\DoxyCodeLine{00425 \}}
\DoxyCodeLine{00426  }
\DoxyCodeLine{00427 \textcolor{keywordtype}{void} Ssao::BuildOffsetVectors()}
\DoxyCodeLine{00428 \{}
\DoxyCodeLine{00429     \textcolor{comment}{// Start with 14 uniformly distributed vectors.  We choose the 8 corners of the cube}}
\DoxyCodeLine{00430     \textcolor{comment}{// and the 6 center points along each cube face.  We always alternate the points on }}
\DoxyCodeLine{00431     \textcolor{comment}{// opposites sides of the cubes.  This way we still get the vectors spread out even}}
\DoxyCodeLine{00432     \textcolor{comment}{// if we choose to use less than 14 samples.}}
\DoxyCodeLine{00433     }
\DoxyCodeLine{00434     \textcolor{comment}{// 8 cube corners}}
\DoxyCodeLine{00435     mOffsets[0] = XMFLOAT4(+1.0f, +1.0f, +1.0f, 0.0f);}
\DoxyCodeLine{00436     mOffsets[1] = XMFLOAT4(-\/1.0f, -\/1.0f, -\/1.0f, 0.0f);}
\DoxyCodeLine{00437 }
\DoxyCodeLine{00438     mOffsets[2] = XMFLOAT4(-\/1.0f, +1.0f, +1.0f, 0.0f);}
\DoxyCodeLine{00439     mOffsets[3] = XMFLOAT4(+1.0f, -\/1.0f, -\/1.0f, 0.0f);}
\DoxyCodeLine{00440 }
\DoxyCodeLine{00441     mOffsets[4] = XMFLOAT4(+1.0f, +1.0f, -\/1.0f, 0.0f);}
\DoxyCodeLine{00442     mOffsets[5] = XMFLOAT4(-\/1.0f, -\/1.0f, +1.0f, 0.0f);}
\DoxyCodeLine{00443 }
\DoxyCodeLine{00444     mOffsets[6] = XMFLOAT4(-\/1.0f, +1.0f, -\/1.0f, 0.0f);}
\DoxyCodeLine{00445     mOffsets[7] = XMFLOAT4(+1.0f, -\/1.0f, +1.0f, 0.0f);}
\DoxyCodeLine{00446 }
\DoxyCodeLine{00447     \textcolor{comment}{// 6 centers of cube faces}}
\DoxyCodeLine{00448     mOffsets[8] = XMFLOAT4(-\/1.0f, 0.0f, 0.0f, 0.0f);}
\DoxyCodeLine{00449     mOffsets[9] = XMFLOAT4(+1.0f, 0.0f, 0.0f, 0.0f);}
\DoxyCodeLine{00450 }
\DoxyCodeLine{00451     mOffsets[10] = XMFLOAT4(0.0f, -\/1.0f, 0.0f, 0.0f);}
\DoxyCodeLine{00452     mOffsets[11] = XMFLOAT4(0.0f, +1.0f, 0.0f, 0.0f);}
\DoxyCodeLine{00453 }
\DoxyCodeLine{00454     mOffsets[12] = XMFLOAT4(0.0f, 0.0f, -\/1.0f, 0.0f);}
\DoxyCodeLine{00455     mOffsets[13] = XMFLOAT4(0.0f, 0.0f, +1.0f, 0.0f);}
\DoxyCodeLine{00456 }
\DoxyCodeLine{00457     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 14; ++i)}
\DoxyCodeLine{00458     \{}
\DoxyCodeLine{00459         \textcolor{comment}{// Create random lengths in [0.25, 1.0].}}
\DoxyCodeLine{00460         \textcolor{keywordtype}{float} s = MathHelper::RandF(0.25f, 1.0f);}
\DoxyCodeLine{00461         }
\DoxyCodeLine{00462         XMVECTOR v = s * XMVector4Normalize(XMLoadFloat4(\&mOffsets[i]));}
\DoxyCodeLine{00463         }
\DoxyCodeLine{00464         XMStoreFloat4(\&mOffsets[i], v);}
\DoxyCodeLine{00465     \}}
\DoxyCodeLine{00466 \}}
\DoxyCodeLine{00467 }

\end{DoxyCode}
