\doxysection{d3d\+Util.\+cpp}
\label{d3d_util_8cpp_source}\index{Common/d3dUtil.cpp@{Common/d3dUtil.cpp}}
\textbf{ Go to the documentation of this file.}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001 }
\DoxyCodeLine{00002 \textcolor{preprocessor}{\#include "{}d3dUtil.h"{}}}
\DoxyCodeLine{00003 \textcolor{preprocessor}{\#include <comdef.h>}}
\DoxyCodeLine{00004 \textcolor{preprocessor}{\#include <fstream>}}
\DoxyCodeLine{00005 }
\DoxyCodeLine{00006 \textcolor{keyword}{using} Microsoft::WRL::ComPtr;}
\DoxyCodeLine{00007 }
\DoxyCodeLine{00008 DxException::DxException(HRESULT hr, \textcolor{keyword}{const} std::wstring\& functionName, \textcolor{keyword}{const} std::wstring\& filename, \textcolor{keywordtype}{int} lineNumber) :}
\DoxyCodeLine{00009     ErrorCode(hr),}
\DoxyCodeLine{00010     FunctionName(functionName),}
\DoxyCodeLine{00011     Filename(filename),}
\DoxyCodeLine{00012     LineNumber(lineNumber)}
\DoxyCodeLine{00013 \{}
\DoxyCodeLine{00014 \}}
\DoxyCodeLine{00015 }
\DoxyCodeLine{00016 \textcolor{keywordtype}{bool} d3dUtil::IsKeyDown(\textcolor{keywordtype}{int} vkeyCode)}
\DoxyCodeLine{00017 \{}
\DoxyCodeLine{00018     \textcolor{keywordflow}{return} (GetAsyncKeyState(vkeyCode) \& 0x8000) != 0;}
\DoxyCodeLine{00019 \}}
\DoxyCodeLine{00020 }
\DoxyCodeLine{00021 ComPtr<ID3DBlob> d3dUtil::LoadBinary(\textcolor{keyword}{const} std::wstring\& filename)}
\DoxyCodeLine{00022 \{}
\DoxyCodeLine{00023     std::ifstream fin(filename, std::ios::binary);}
\DoxyCodeLine{00024 }
\DoxyCodeLine{00025     fin.seekg(0, std::ios\_base::end);}
\DoxyCodeLine{00026     std::ifstream::pos\_type size = (int)fin.tellg();}
\DoxyCodeLine{00027     fin.seekg(0, std::ios\_base::beg);}
\DoxyCodeLine{00028 }
\DoxyCodeLine{00029     ComPtr<ID3DBlob> blob;}
\DoxyCodeLine{00030     ThrowIfFailed(D3DCreateBlob(size, blob.GetAddressOf()));}
\DoxyCodeLine{00031 }
\DoxyCodeLine{00032     fin.read((\textcolor{keywordtype}{char}*)blob-\/>GetBufferPointer(), size);}
\DoxyCodeLine{00033     fin.close();}
\DoxyCodeLine{00034 }
\DoxyCodeLine{00035     \textcolor{keywordflow}{return} blob;}
\DoxyCodeLine{00036 \}}
\DoxyCodeLine{00037 }
\DoxyCodeLine{00038 Microsoft::WRL::ComPtr<ID3D12Resource> d3dUtil::CreateDefaultBuffer(}
\DoxyCodeLine{00039     ID3D12Device* device,}
\DoxyCodeLine{00040     ID3D12GraphicsCommandList* cmdList,}
\DoxyCodeLine{00041     \textcolor{keyword}{const} \textcolor{keywordtype}{void}* initData,}
\DoxyCodeLine{00042     UINT64 byteSize,}
\DoxyCodeLine{00043     Microsoft::WRL::ComPtr<ID3D12Resource>\& uploadBuffer)}
\DoxyCodeLine{00044 \{}
\DoxyCodeLine{00045     ComPtr<ID3D12Resource> defaultBuffer;}
\DoxyCodeLine{00046 }
\DoxyCodeLine{00047     \textcolor{comment}{// Create the actual default buffer resource.}}
\DoxyCodeLine{00048     ThrowIfFailed(device-\/>CreateCommittedResource(}
\DoxyCodeLine{00049         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_DEFAULT),}
\DoxyCodeLine{00050         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00051         \&CD3DX12\_RESOURCE\_DESC::Buffer(byteSize),}
\DoxyCodeLine{00052         D3D12\_RESOURCE\_STATE\_COMMON,}
\DoxyCodeLine{00053         \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00054         IID\_PPV\_ARGS(defaultBuffer.GetAddressOf())));}
\DoxyCodeLine{00055 }
\DoxyCodeLine{00056     \textcolor{comment}{// In order to copy CPU memory data into our default buffer, we need to create}}
\DoxyCodeLine{00057     \textcolor{comment}{// an intermediate upload heap. }}
\DoxyCodeLine{00058     ThrowIfFailed(device-\/>CreateCommittedResource(}
\DoxyCodeLine{00059         \&CD3DX12\_HEAP\_PROPERTIES(D3D12\_HEAP\_TYPE\_UPLOAD),}
\DoxyCodeLine{00060         D3D12\_HEAP\_FLAG\_NONE,}
\DoxyCodeLine{00061         \&CD3DX12\_RESOURCE\_DESC::Buffer(byteSize),}
\DoxyCodeLine{00062         D3D12\_RESOURCE\_STATE\_GENERIC\_READ,}
\DoxyCodeLine{00063         \textcolor{keyword}{nullptr},}
\DoxyCodeLine{00064         IID\_PPV\_ARGS(uploadBuffer.GetAddressOf())));}
\DoxyCodeLine{00065 }
\DoxyCodeLine{00066 }
\DoxyCodeLine{00067     \textcolor{comment}{// Describe the data we want to copy into the default buffer.}}
\DoxyCodeLine{00068     D3D12\_SUBRESOURCE\_DATA subResourceData = \{\};}
\DoxyCodeLine{00069     subResourceData.pData = initData;}
\DoxyCodeLine{00070     subResourceData.RowPitch = byteSize;}
\DoxyCodeLine{00071     subResourceData.SlicePitch = subResourceData.RowPitch;}
\DoxyCodeLine{00072 }
\DoxyCodeLine{00073     \textcolor{comment}{// Schedule to copy the data to the default buffer resource.  At a high level, the helper function UpdateSubresources}}
\DoxyCodeLine{00074     \textcolor{comment}{// will copy the CPU memory into the intermediate upload heap.  Then, using ID3D12CommandList::CopySubresourceRegion,}}
\DoxyCodeLine{00075     \textcolor{comment}{// the intermediate upload heap data will be copied to mBuffer.}}
\DoxyCodeLine{00076     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(defaultBuffer.Get(), }
\DoxyCodeLine{00077         D3D12\_RESOURCE\_STATE\_COMMON, D3D12\_RESOURCE\_STATE\_COPY\_DEST));}
\DoxyCodeLine{00078     UpdateSubresources<1>(cmdList, defaultBuffer.Get(), uploadBuffer.Get(), 0, 0, 1, \&subResourceData);}
\DoxyCodeLine{00079     cmdList-\/>ResourceBarrier(1, \&CD3DX12\_RESOURCE\_BARRIER::Transition(defaultBuffer.Get(),}
\DoxyCodeLine{00080         D3D12\_RESOURCE\_STATE\_COPY\_DEST, D3D12\_RESOURCE\_STATE\_GENERIC\_READ));}
\DoxyCodeLine{00081 }
\DoxyCodeLine{00082     \textcolor{comment}{// Note: uploadBuffer has to be kept alive after the above function calls because}}
\DoxyCodeLine{00083     \textcolor{comment}{// the command list has not been executed yet that performs the actual copy.}}
\DoxyCodeLine{00084     \textcolor{comment}{// The caller can Release the uploadBuffer after it knows the copy has been executed.}}
\DoxyCodeLine{00085 }
\DoxyCodeLine{00086 }
\DoxyCodeLine{00087     \textcolor{keywordflow}{return} defaultBuffer;}
\DoxyCodeLine{00088 \}}
\DoxyCodeLine{00089 }
\DoxyCodeLine{00090 ComPtr<ID3DBlob> d3dUtil::CompileShader(}
\DoxyCodeLine{00091     \textcolor{keyword}{const} std::wstring\& filename,}
\DoxyCodeLine{00092     \textcolor{keyword}{const} D3D\_SHADER\_MACRO* defines,}
\DoxyCodeLine{00093     \textcolor{keyword}{const} std::string\& entrypoint,}
\DoxyCodeLine{00094     \textcolor{keyword}{const} std::string\& target)}
\DoxyCodeLine{00095 \{}
\DoxyCodeLine{00096     UINT compileFlags = 0;}
\DoxyCodeLine{00097 \textcolor{preprocessor}{\#if defined(DEBUG) || defined(\_DEBUG)  }}
\DoxyCodeLine{00098     compileFlags = D3DCOMPILE\_DEBUG | D3DCOMPILE\_SKIP\_OPTIMIZATION;}
\DoxyCodeLine{00099 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00100 }
\DoxyCodeLine{00101     HRESULT hr = S\_OK;}
\DoxyCodeLine{00102 }
\DoxyCodeLine{00103     ComPtr<ID3DBlob> byteCode = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00104     ComPtr<ID3DBlob> errors;}
\DoxyCodeLine{00105     hr = D3DCompileFromFile(filename.c\_str(), defines, D3D\_COMPILE\_STANDARD\_FILE\_INCLUDE,}
\DoxyCodeLine{00106         entrypoint.c\_str(), target.c\_str(), compileFlags, 0, \&byteCode, \&errors);}
\DoxyCodeLine{00107 }
\DoxyCodeLine{00108     \textcolor{keywordflow}{if}(errors != \textcolor{keyword}{nullptr})}
\DoxyCodeLine{00109         OutputDebugStringA((\textcolor{keywordtype}{char}*)errors-\/>GetBufferPointer());}
\DoxyCodeLine{00110 }
\DoxyCodeLine{00111     ThrowIfFailed(hr);}
\DoxyCodeLine{00112 }
\DoxyCodeLine{00113     \textcolor{keywordflow}{return} byteCode;}
\DoxyCodeLine{00114 \}}
\DoxyCodeLine{00115 }
\DoxyCodeLine{00116 std::wstring DxException::ToString()\textcolor{keyword}{const}}
\DoxyCodeLine{00117 \textcolor{keyword}{}\{}
\DoxyCodeLine{00118     \textcolor{comment}{// Get the string description of the error code.}}
\DoxyCodeLine{00119     \_com\_error err(ErrorCode);}
\DoxyCodeLine{00120     std::wstring msg = err.ErrorMessage();}
\DoxyCodeLine{00121 }
\DoxyCodeLine{00122     \textcolor{keywordflow}{return} FunctionName + L\textcolor{stringliteral}{"{} failed in "{}} + Filename + L\textcolor{stringliteral}{"{}; line "{}} + std::to\_wstring(LineNumber) + L\textcolor{stringliteral}{"{}; error: "{}} + msg;}
\DoxyCodeLine{00123 \}}
\DoxyCodeLine{00124 }
\DoxyCodeLine{00125 }
\DoxyCodeLine{00126 }
\DoxyCodeLine{00127 }
\DoxyCodeLine{00128 }

\end{DoxyCode}
